# å¤§é‡ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—è¨­è¨ˆ (Load More ãƒ‘ã‚¿ãƒ¼ãƒ³)

## èƒŒæ™¯

Nostr ã®ãƒªãƒ¬ãƒ¼ã¯ REQ ã«å¯¾ã—ã¦è¿”ã™ã‚¤ãƒ™ãƒ³ãƒˆæ•°ã«ä¸Šé™ã‚’è¨­ã‘ã¦ã„ã‚‹ï¼ˆãƒªãƒ¬ãƒ¼ã”ã¨ã«ç•°ãªã‚‹ãŒã€ä¸€èˆ¬çš„ã« 100ã€œ500ä»¶ï¼‰ã€‚
ç¾åœ¨ã® `loadAllData()` ã¯ `limit` / `until` ã‚’æŒ‡å®šã›ãšã€1å›ã® REQ ã§å…¨ä»¶ã‚’æœŸå¾…ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãŒå¢—ãˆã‚‹ã¨ **å–ã‚Šã“ã¼ã—** ãŒç™ºç”Ÿã™ã‚‹ã€‚

### kind 30078 ã®ç‰¹æ€§

kind 30078 ã¯ **Parameterized Replaceable Event** (PRE)ã€‚
åŒä¸€ `pubkey + kind + d-tag` ã®çµ„ã¿åˆã‚ã›ã«å¯¾ã—ã€æœ€æ–°ã®1ä»¶ã®ã¿ãŒæœ‰åŠ¹ã€‚
ãƒªãƒ¬ãƒ¼ãŒæ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚Œã°æœ‰åŠ¹ã‚¤ãƒ™ãƒ³ãƒˆæ•° = ãƒ¦ãƒ‹ãƒ¼ã‚¯ãª d-tag ã®æ•°ã€‚

---

## è¨­è¨ˆæ–¹é‡: Load More ãƒ‘ã‚¿ãƒ¼ãƒ³

### è‡ªå‹•å…¨ä»¶å–å¾—ã§ã¯ãªãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸»å°ã®ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«å–å¾—

```
åˆå›ãƒ­ã‚°ã‚¤ãƒ³
  â†’ æœ€æ–° BATCH_SIZE ä»¶ã‚’å–å¾— (é«˜é€Ÿ)
  â†’ ç”»é¢è¡¨ç¤º

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œã‚‚ã£ã¨èª­ã‚€ã€ã‚’æŠ¼ã™
  â†’ æ¬¡ã® BATCH_SIZE ä»¶ã‚’å–å¾— (until ã‚«ãƒ¼ã‚½ãƒ«)
  â†’ ã‚¹ãƒˆã‚¢ã«è¿½è¨˜
  â†’ ã¾ã ã‚ã‚Šãã†ãªã‚‰å†åº¦ãƒœã‚¿ãƒ³è¡¨ç¤º
```

**ãƒ¡ãƒªãƒƒãƒˆ:**

- åˆæœŸè¡¨ç¤ºãŒé€Ÿã„ (æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã ã‘å–å¾—)
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¿…è¦ãªæ™‚ã ã‘éå»ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
- ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ãŒæ®µéšçš„
- å®Ÿè£…ãŒã‚·ãƒ³ãƒ—ãƒ« (å„ãƒãƒƒãƒã¯ç‹¬ç«‹ã—ãŸ req)

---

## ã‚³ã‚¢è¨­è¨ˆ

### `fetchBatch()` â€” å˜ä¸€ãƒãƒƒãƒå–å¾—

```typescript
const BATCH_SIZE = 200;

interface BatchResult {
  events: NostrEvent[];
  oldestCreatedAt: number;
}

function fetchBatch(pubkey: string, until: number): Promise<BatchResult>;
```

- `until` + `limit: BATCH_SIZE` ã§ REQ ã‚’ç™ºè¡Œ
- EOSE (complete) ã§ resolve
- 10ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

### `loadAllData()` â€” åˆå›å–å¾— (æœ€æ–°ãƒãƒƒãƒã®ã¿)

```typescript
async function loadAllData(
  pubkey: string,
): Promise<LoadedData & { hasMore: boolean; cursor: number }>;
```

- å†…éƒ¨ã§ `fetchBatch(pubkey, now + 1)` ã‚’1å›å‘¼ã¶
- æˆ»ã‚Šå€¤ã« `hasMore` (å–å¾—ä»¶æ•° === BATCH_SIZE) ã¨ `cursor` (æœ€å¤ã® created_at) ã‚’å«ã‚€
- åˆå›ã ã‘ã¯è»Šä¸¡ãƒ‡ãƒ¼ã‚¿ (vehicle:\*) ã‚’ç¢ºå®Ÿã«å–å¾—ã™ã‚‹ãŸã‚ã€å–å¾—ä»¶æ•°ãŒ BATCH_SIZE ã´ã£ãŸã‚Šã§ã‚‚è»Šä¸¡ã¯å«ã¾ã‚Œã¦ã„ã‚‹å‰æ

### `loadMoreData()` â€” è¿½åŠ å–å¾—

```typescript
async function loadMoreData(
  pubkey: string,
  cursor: number,
): Promise<LoadedData & { hasMore: boolean; cursor: number }>;
```

- `fetchBatch(pubkey, cursor)` ã§æ¬¡ãƒãƒƒãƒã‚’å–å¾—
- ãƒ‘ãƒ¼ã‚¹çµæœ + æ–°ã—ã„ `hasMore` / `cursor` ã‚’è¿”ã™

---

## ã‚¹ãƒˆã‚¢è¨­è¨ˆ

### `paginationStore` â€” ã‚«ãƒ¼ã‚½ãƒ«çŠ¶æ…‹ç®¡ç†

```typescript
// app.svelte.ts
let _hasMore = $state(false);
let _cursor = $state(0);
let _loadingMore = $state(false);

export const pagination = {
  get hasMore() {
    return _hasMore;
  },
  get cursor() {
    return _cursor;
  },
  get loadingMore() {
    return _loadingMore;
  },

  setCursor(cursor: number, hasMore: boolean) {
    _cursor = cursor;
    _hasMore = hasMore;
  },
  setLoadingMore(v: boolean) {
    _loadingMore = v;
  },
  clear() {
    _hasMore = false;
    _cursor = 0;
    _loadingMore = false;
  },
};
```

### `records.appendAll()` â€” æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«è¿½è¨˜

```typescript
appendAll(data: LoadedData) {
  _refuels = [..._refuels, ...data.refuels].sort(...);
  _quickRecords = [..._quickRecords, ...data.quickRecords].sort(...);
  // ... å…¨ç¨®åˆ¥åŒæ§˜
}
```

---

## UI: ã€Œã‚‚ã£ã¨èª­ã‚€ã€ãƒœã‚¿ãƒ³

### å±¥æ­´ãƒšãƒ¼ã‚¸ã®æœ«å°¾

```svelte
<!-- history/+page.svelte æœ«å°¾ -->
{#if pagination.hasMore}
  <button onclick={handleLoadMore} disabled={pagination.loadingMore}>
    {#if pagination.loadingMore}
      â³ èª­ã¿è¾¼ã¿ä¸­...
    {:else}
      ğŸ“œ ã‚‚ã£ã¨èª­ã‚€
    {/if}
  </button>
{/if}
```

### ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æœ«å°¾ã«ã‚‚é…ç½®

---

## ãƒ•ãƒ­ãƒ¼å›³

```
[ãƒ­ã‚°ã‚¤ãƒ³]
    â”‚
    â–¼
fetchBatch(pubkey, now+1)  â”€â”€ limit: 200
    â”‚
    â–¼
setAll(data) + setCursor(oldest, events.length === 200)
    â”‚
    â–¼
[ç”»é¢è¡¨ç¤º: æœ€æ–°200ä»¶]
    â”‚
    â”œâ”€â”€ hasMore === false â†’ å®Œäº†ï¼ˆå…¨ä»¶å–å¾—æ¸ˆã¿ï¼‰
    â”‚
    â””â”€â”€ hasMore === true â†’ [ã‚‚ã£ã¨èª­ã‚€] ãƒœã‚¿ãƒ³è¡¨ç¤º
                                â”‚
                                â–¼ (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¯ãƒªãƒƒã‚¯)
                        fetchBatch(pubkey, cursor)
                                â”‚
                                â–¼
                        appendAll(data) + setCursor(...)
                                â”‚
                                â–¼
                        [ç”»é¢ã«è¿½è¨˜è¡¨ç¤º]
                                â”‚
                                â””â”€â”€ ç¹°ã‚Šè¿”ã—...
```

---

## d-tag ãƒ™ãƒ¼ã‚¹ã®é‡è¤‡æ’é™¤

PRE ã®ãŸã‚åŒä¸€ d-tag ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯æœ€æ–°ç‰ˆã®ã¿ãŒæœ‰åŠ¹ã€‚
`appendAll` æ™‚ã«æ—¢å­˜ã®åŒä¸€ d-tag ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Œã° **created_at ãŒæ–°ã—ã„æ–¹ã‚’æ¡ç”¨**:

```typescript
// appendAll å†…
for (const r of data.refuels) {
  const idx = _refuels.findIndex((x) => x.id === r.id);
  if (idx >= 0) {
    if (r.createdAt > _refuels[idx].createdAt) _refuels[idx] = r;
  } else {
    _refuels.push(r);
  }
}
```

---

## ãƒ‡ãƒ¼ã‚¿é‡ã®è©¦ç®—

| åˆ©ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³                    | å¹´é–“ã‚¤ãƒ™ãƒ³ãƒˆæ•° | 5å¹´å¾Œ   | ã€Œã‚‚ã£ã¨èª­ã‚€ã€å›æ•° |
| ------------------------------- | -------------- | ------- | ------------------ |
| ãƒ©ã‚¤ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆé€±1çµ¦æ²¹ï¼‰       | ~100ä»¶         | ~500ä»¶  | 2å›                |
| æ™®é€šãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆæ¯æ—¥æ•´å‚™è¨˜éŒ²ï¼‰    | ~500ä»¶         | ~2500ä»¶ | 12å›               |
| ãƒ˜ãƒ“ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆè¤‡æ•°è»Šä¸¡+æ¯æ—¥ï¼‰ | ~1500ä»¶        | ~7500ä»¶ | 37å›               |

**åˆå›è¡¨ç¤ºã¯å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã§1ãƒãƒƒãƒ(200ä»¶)ã®ã¿ â†’ é«˜é€Ÿ**

---

## æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¸ã®å½±éŸ¿

| ãƒ•ã‚¡ã‚¤ãƒ«               | å¤‰æ›´å†…å®¹                                             |
| ---------------------- | ---------------------------------------------------- |
| `subscribe.ts`         | `fetchBatch` æ–°è¨­ã€`loadAllData` ã‚’1ãƒãƒƒãƒå–å¾—ã«å¤‰æ›´ |
| `app.svelte.ts`        | `pagination` ã‚¹ãƒˆã‚¢ + `records.appendAll()` è¿½åŠ      |
| `+layout.svelte`       | `loadAllData` ã®æˆ»ã‚Šå€¤ã‹ã‚‰ã‚«ãƒ¼ã‚½ãƒ«è¨­å®š               |
| `history/+page.svelte` | æœ«å°¾ã«ã€Œã‚‚ã£ã¨èª­ã‚€ã€ãƒœã‚¿ãƒ³                           |
| `home/+page.svelte`    | ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æœ«å°¾ã«ã€Œã‚‚ã£ã¨èª­ã‚€ã€ãƒœã‚¿ãƒ³               |
| ä»–ã® UI ãƒšãƒ¼ã‚¸         | **å¤‰æ›´ãªã—**                                         |

---

## å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

1. `subscribe.ts` ã« `fetchBatch()` ã‚’æ–°è¨­
2. `loadAllData()` ã‚’ fetchBatch 1å› + hasMore/cursor ä»˜ãæˆ»ã‚Šå€¤ã«å¤‰æ›´
3. `loadMoreData()` ã‚’æ–°è¨­
4. `app.svelte.ts` ã« `pagination` ã‚¹ãƒˆã‚¢ + `records.appendAll()` è¿½åŠ 
5. `+layout.svelte` ã§åˆå›å–å¾—å¾Œã«ã‚«ãƒ¼ã‚½ãƒ«è¨­å®š
6. `history/+page.svelte` ã«ã€Œã‚‚ã£ã¨èª­ã‚€ã€ãƒœã‚¿ãƒ³è¿½åŠ 
7. `home/+page.svelte` ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã«ã‚‚ã€Œã‚‚ã£ã¨èª­ã‚€ã€è¿½åŠ 
