# Nostr Moto Log - バイクメンテナンス記録アプリ 設計書

## 1. プロジェクト概要

バイクの給油・メンテナンス履歴を **Nostr の kind 30078 (Application‑specific Data)** に保存し、
Web アプリ上で記録の登録・閲覧・燃費分析などを行えるようにする。

### コンセプト

- **気軽さ最優先** — 面倒にならない。最小限のタップで記録できる
- データ抜けがあっても大丈夫。途中から再開しても壊れない
- バイク初心者でも「何をいつ点検すべきか」がわかる
- 給油記録から燃費を自動計算し、バイクのコンディション変化に気づける
- Nostr に保存するため、サーバー不要・データポータブル

### 気軽さのための設計方針

1. **必須項目ゼロ** — 給油は「満タンにした!」だけで記録できる。給油量・ODO・単価すべて任意
2. **スマートデフォルト** — 前回の値を記憶して自動入力 (燃料種別、よく行くスタンド等)
3. **ワンタップ記録** — 点検は「全部OK!」ボタン1つで完了。異常があるときだけ個別入力
4. **「やった」だけでいい** — 空気圧入れた、チェーン注油した、はタップ1つで日時記録
5. **データ欠損に寛容** — ODO 未入力の記録があっても、入力済みの記録同士で燃費計算
6. **推定で補完** — 給油量がわからなくても、満タン記録 + タンク容量 + 平均燃費から残燃料を推定

---

## 2. 技術スタック

| レイヤー             | 技術                                        |
| -------------------- | ------------------------------------------- |
| フレームワーク       | **SvelteKit** (Svelte 5 / Runes)            |
| ビルドツール         | Vite (SvelteKit 内蔵)                       |
| UI / スタイル        | Tailwind CSS 4                              |
| Nostr リレー管理     | **rx-nostr** + nostr-tools                  |
| ログイン             | **@konemono/nostr-login** (NIP-07 / NIP-46) |
| チャート             | Chart.js + svelte-chartjs                   |
| デプロイ             | Vercel / Cloudflare Pages (静的アダプタ)    |
| パッケージマネージャ | pnpm                                        |

### なぜこの構成か

- **SvelteKit** — ファイルベースルーティング、SSG 対応、Svelte 5 の Runes で状態管理がシンプル
- **rx-nostr** — RxJS ベースでリレー接続・再接続・購読管理が堅牢。複数リレーへの publish/subscribe を宣言的に書ける
- **@konemono/nostr-login** — NIP-07 (ブラウザ拡張) と NIP-46 (リモート署名) の両方に対応。ログイン UI も提供
- **Chart.js** — Svelte と相性がよく軽量。Recharts は React 専用なので不使用

---

## 3. Nostr データ設計

### 3.1 使用する Event Kind

**kind 30078** — Parameterized Replaceable Event (アプリ固有データ)

- 同じ `pubkey` + `kind` + `d` タグ の組み合わせで 1 つのイベントとなる
- 各レコードに一意の `d` タグを付与し、個別に更新・削除可能

### 3.2 アプリ識別タグ

すべてのイベントに以下のタグを付与し、他アプリのデータと区別する:

```json
["L", "nostr-moto-log"]
```

### 3.3 d タグ命名規則

| レコード種別       | d タグパターン                                        | 例                                          |
| ------------------ | ----------------------------------------------------- | ------------------------------------------- |
| 車両プロフィール   | `vehicle:{vehicleId}`                                 | `vehicle:ninja400-2024`                     |
| 給油記録           | `refuel:{vehicleId}:{timestamp}`                      | `refuel:ninja400-2024:1708000000`           |
| クイック整備記録   | `quick:{vehicleId}:{timestamp}`                       | `quick:ninja400-2024:1708000000`            |
| 走行記録 (ODO更新) | `odometer:{vehicleId}:{timestamp}`                    | `odometer:ninja400-2024:1708000000`         |
| 点検記録           | `inspection:{vehicleId}:{inspectionType}:{timestamp}` | `inspection:ninja400-2024:daily:1708000000` |
| ショップ整備       | `shop:{vehicleId}:{timestamp}`                        | `shop:ninja400-2024:1708000000`             |

### 3.4 イベント構造

#### 車両プロフィール

```json
{
  "kind": 30078,
  "tags": [
    ["d", "vehicle:ninja400-2024"],
    ["L", "nostr-moto-log"],
    ["l", "vehicle", "nostr-moto-log"]
  ],
  "content": "{JSON文字列}",
  "created_at": 1708000000
}
```

content JSON:

```json
{
  "v": 1,
  "name": "Ninja 400",
  "maker": "Kawasaki",
  "year": 2024,
  "displacement": 399,
  "fuelTankCapacity": 14,
  "fuelType": "regular",
  "recommendedTirePressureFront": 225,
  "recommendedTirePressureRear": 250
}
```

> 最低限 `name` だけで登録可能。他は任意。  
> `fuelType`: `"regular"` | `"premium"` | `"diesel"`

#### 給油記録

```json
{
  "kind": 30078,
  "tags": [
    ["d", "refuel:ninja400-2024:1708000000"],
    ["L", "nostr-moto-log"],
    ["l", "refuel", "nostr-moto-log"]
  ],
  "content": "{JSON文字列}",
  "created_at": 1708000000
}
```

content JSON:

```json
{
  "v": 1,
  "vehicleId": "ninja400-2024",
  "date": "2025-02-15",
  "fuelAmount": 10.5,
  "isFullTank": true,
  "odometer": 5230,
  "pricePerLiter": 175,
  "totalCost": 1838,
  "station": "ENEOS 〇〇店",
  "notes": ""
}
```

> **必須項目なし**。「給油した」という事実だけで記録可能。  
> `fuelAmount` — 任意。不明なら省略してよい。  
> `isFullTank` — デフォルト `true`。満タンにしなかった場合のみ `false` に。  
> `odometer` を入れれば燃費計算に使われる。入れなくても記録としては有効。  
> `totalCost` か `pricePerLiter` のどちらかを入れれば、もう片方は自動計算。

##### 給油量不明の満タン記録

覚えているのは「満タンにした」だけ、給油量がわからないケース:

```json
{
  "v": 1,
  "vehicleId": "ninja400-2024",
  "date": "2025-01-25",
  "isFullTank": true,
  "odometer": 5100
}
```

> この記録は:
>
> - 燃費計算の**基準点** (この時点でタンクは `fuelTankCapacity` と同量) として機能
> - 次回の給油量がわかるまで「消費燃料」が不明なため、この記録自体の燃費は計算不可
> - ただし次の満タン給油で量がわかれば、その区間の燃費は正常に計算できる
> - **推定残燃料**の計算に利用: タンク容量 − (走行距離 ÷ 平均燃費)

#### クイック整備記録 (ワンタップ系)

「やった」をタップするだけで記録できる軽量レコード。

content JSON:

```json
{
  "v": 1,
  "vehicleId": "ninja400-2024",
  "date": "2025-02-15",
  "action": "tire-pressure",
  "odometer": 5200,
  "details": {
    "frontPressure": 225,
    "rearPressure": 250
  },
  "notes": ""
}
```

> **必須: `action` のみ**。`odometer` も `details` も任意。  
> `action` の種類:

| action           | 説明              | details (任意)                        |
| ---------------- | ----------------- | ------------------------------------- |
| `tire-pressure`  | 空気圧調整        | `frontPressure`, `rearPressure` (kPa) |
| `chain-lube`     | チェーン注油      | —                                     |
| `chain-clean`    | チェーン清掃      | —                                     |
| `chain-adjust`   | チェーン張り調整  | —                                     |
| `wash`           | 洗車              | —                                     |
| `oil-check`      | オイル量チェック  | `level`: `"ok"` \| `"low"`            |
| `coolant-check`  | 冷却水チェック    | `level`: `"ok"` \| `"low"`            |
| `battery-charge` | バッテリー充電    | —                                     |
| `custom`         | その他 (自由記述) | `description`                         |

#### 走行記録 (ODO 更新)

給油以外のタイミングで ODO を記録したいとき用。

content JSON:

```json
{
  "v": 1,
  "vehicleId": "ninja400-2024",
  "date": "2025-02-15",
  "odometer": 5500,
  "notes": "ツーリング帰り"
}
```

#### 点検記録

content JSON:

```json
{
  "v": 1,
  "vehicleId": "ninja400-2024",
  "date": "2025-02-15",
  "type": "daily",
  "odometer": 5230,
  "allOk": true,
  "issues": [],
  "notes": ""
}
```

> **基本は `allOk: true` (ワンタップ)。** 問題があるときだけ `issues` に記載:

```json
{
  "v": 1,
  "vehicleId": "ninja400-2024",
  "date": "2025-02-15",
  "type": "daily",
  "allOk": false,
  "issues": [
    {
      "item": "tireConditionFront",
      "status": "warning",
      "note": "溝が減ってきた"
    },
    { "item": "chainCondition", "status": "ng", "note": "伸びすぎ、要調整" }
  ],
  "notes": ""
}
```

> `type`: `"daily"` | `"weekly"` | `"monthly"`  
> `status`: `"warning"` | `"ng"`  
> `item` には各点検カテゴリの項目キーが入る (後述の点検項目表を参照)

#### ショップ整備記録

content JSON:

```json
{
  "v": 1,
  "vehicleId": "ninja400-2024",
  "date": "2025-02-15",
  "odometer": 10000,
  "category": "regular",
  "shopName": "レッドバロン 〇〇店",
  "workDone": ["oilChange", "oilFilterChange", "chainAdjust"],
  "totalCost": 15000,
  "nextDate": "2025-08-15",
  "nextOdometer": 16000,
  "notes": "オイル: Kawasaki 純正 10W-40"
}
```

> `category`: `"regular"` (定期) | `"repair"` (修理) | `"shaken"` (車検) | `"custom"` (カスタム)  
> `workDone` — やってもらった作業を配列で。false の項目を列挙するより直感的。  
> **必須項目なし** — 極端に言えば「バイク屋行った」だけでも記録可能。

---

## 4. 画面設計

### 4.1 画面一覧 (SvelteKit ルーティング)

| #   | 画面名       | パス              | 説明                                     |
| --- | ------------ | ----------------- | ---------------------------------------- |
| 1   | ログイン     | `/`               | @konemono/nostr-login でログイン         |
| 2   | ホーム       | `/home`           | ダッシュボード。燃費・直近記録・アラート |
| 3   | 記録する     | `/log`            | クイック記録の入口。ここから各フォームへ |
| 4   | 給油         | `/log/refuel`     | 給油記録フォーム                         |
| 5   | クイック整備 | `/log/quick`      | ワンタップ整備記録                       |
| 6   | 点検         | `/log/inspection` | 点検チェック (日常/週間/月間)            |
| 7   | ショップ     | `/log/shop`       | バイク屋さんの整備記録                   |
| 8   | 履歴         | `/history`        | 全記録のタイムライン                     |
| 9   | 統計         | `/stats`          | 燃費・コスト・走行距離の分析             |
| 10  | 車両         | `/vehicle`        | 車両プロフィール                         |
| 11  | 設定         | `/settings`       | リレー設定                               |

### 4.2 ホーム画面 (ダッシュボード)

```
┌──────────────────────────────────────────────┐
│  🏍 Nostr Moto Log                      [⚙] │
│  Ninja 400                                   │
├──────────────────────────────────────────────┤
│                                              │
│  ┌─ 燃費 ────────────────────────────────┐  │
│  │  直近         平均         最高       │  │
│  │  26.2 km/L   28.5 km/L   32.1 km/L  │  │
│  └───────────────────────────────────────┘  │
│                                              │
│  ┌─ ⛽ 推定残燃料 ────────────────────────┐  │
│  │                                       │  │
│  │  ████████░░░░ 6.9L / 14L              │  │
│  │  推定航続距離: あと 193 km            │  │
│  │                                       │  │
│  └───────────────────────────────────────┘  │
│                                              │
│  ┌─ 📈 燃費推移 (最近10回) ──────────────┐  │
│  │  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~         │  │
│  └───────────────────────────────────────┘  │
│                                              │
│  ┌─ そろそろやろう ──────────────────────┐  │
│  │ 🔴 オイル交換 800km超過              │  │
│  │ 🟡 チェーン注油 前回から12日          │  │
│  │ 🟢 空気圧 3日前に確認済み             │  │
│  └───────────────────────────────────────┘  │
│                                              │
│  ┌─ 最近の記録 ──────────────────────────┐  │
│  │ 2/14 ⛽ 10.5L → 26.2km/L             │  │
│  │ 2/10 🔧 チェーン注油                 │  │
│  │ 2/08 💨 空気圧 F225 R250             │  │
│  └───────────────────────────────────────┘  │
│                                              │
├──────────────────────────────────────────────┤
│                                              │
│    ⛽          🔧         📋        📊     │
│   給油      クイック     点検      統計     │
│             整備                             │
└──────────────────────────────────────────────┘
```

### 4.3 記録画面 (`/log`) — クイック記録ハブ

```
┌──────────────────────────────────────────────┐
│  記録する                                    │
├──────────────────────────────────────────────┤
│                                              │
│  ┌────────────────────────────────────────┐  │
│  │  ⛽ 給油した                    →     │  │
│  └────────────────────────────────────────┘  │
│                                              │
│  ワンタップ整備 (タップで即記録!)             │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐       │
│  │ 💨   │ │ 🔗   │ │ 🧴   │ │ 🚿   │       │
│  │空気圧│ │チェーン│ │注油 │ │洗車  │       │
│  │入れた│ │調整   │ │した  │ │した  │       │
│  └──────┘ └──────┘ └──────┘ └──────┘       │
│  ┌──────┐ ┌──────┐ ┌──────┐                 │
│  │ 🔋   │ │ 🛢   │ │ 📝   │                 │
│  │バッテリ│ │オイル │ │その他│                │
│  │充電  │ │確認   │ │      │                 │
│  └──────┘ └──────┘ └──────┘                 │
│                                              │
│  ┌────────────────────────────────────────┐  │
│  │  📋 点検する (日常/週間/月間)    →    │  │
│  └────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────┐  │
│  │  🏭 バイク屋の整備を記録        →    │  │
│  └────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────┐  │
│  │  📏 走行距離 (ODO) を記録       →    │  │
│  └────────────────────────────────────────┘  │
│                                              │
└──────────────────────────────────────────────┘
```

> ワンタップ整備はタップした瞬間に「記録しました!」トーストが出て保存完了。  
> 詳細を追加したければトーストの「詳細を追加」リンクから編集へ。

### 4.4 給油記録フォーム (`/log/refuel`)

**気軽さ重視の段階的フォーム。「満タンにした!」ワンタップでも、詳細入力でもOK:**

```
┌──────────────────────────────────────────────┐
│  ← 給油記録                                  │
├──────────────────────────────────────────────┤
│                                              │
│  ┌────────────────────────────────────────┐  │
│  │    ⛽ 満タンにした!                    │  │
│  │    (量がわからなくてもOK)              │  │
│  └────────────────────────────────────────┘  │
│                                              │
│  ── 以下すべて任意 (わかる分だけ入力) ──     │
│                                              │
│  日付    [ 2025-01-25       ]                │
│  満タン  [●━━ ON ]                           │
│                                              │
│  ▼ 給油量・金額                               │
│    給油量  [           L ]                   │
│    合計金額 [         ¥ ]                    │
│    or 単価 [         ¥/L ]                   │
│                                              │
│  ▼ 走行距離                                  │
│    ODO   [         km ]                      │
│    (前回: 5,100 km)                          │
│                                              │
│  ▼ その他                                    │
│    スタンド [ ENEOS 〇〇店     ] ← 履歴候補  │
│    メモ    [                   ]             │
│                                              │
│  ┌────────────────────────────────────────┐  │
│  │          ⛽ 記録する                   │  │
│  └────────────────────────────────────────┘  │
│                                              │
└──────────────────────────────────────────────┘
```

> - **「満タンにした!」ボタン**がメイン。タップ1つで `isFullTank: true` の記録を保存 → 量不明でもOK
> - 下に詳細フォームを展開すれば、給油量・金額・ODO等を追加入力可能
> - 満タン OFF にすると「途中給油」記録になる (この場合は給油量があったほうが計算に有用)
> - 任意セクションは折りたたみ (アコーディオン)。最初は閉じておく
> - スタンド名は過去の入力履歴からサジェスト
> - 燃料種別は車両プロフィールの `fuelType` をデフォルト使用、フォームには非表示 (設定で変更可)

### 4.5 点検フォーム (`/log/inspection`)

```
┌──────────────────────────────────────────────┐
│  ← 点検                                     │
├──────────────────────────────────────────────┤
│                                              │
│  [日常] [週間] [月間]  ← タブ切替             │
│                                              │
│  ─── 日常点検 ───                             │
│  乗る前にざっと見て問題なければ:              │
│                                              │
│  ┌────────────────────────────────────────┐  │
│  │    ✅ 全部 OK!                         │  │
│  └────────────────────────────────────────┘  │
│                                              │
│  気になるところがあれば個別にチェック:        │
│                                              │
│  ブレーキ         [OK ✓] [気になる] [NG]     │
│  タイヤ           [OK ✓] [気になる] [NG]     │
│  灯火類           [OK ✓] [気になる] [NG]     │
│  チェーン         [OK ✓] [気になる] [NG]     │
│  エンジン周り     [OK ✓] [気になる] [NG]     │
│  操作系           [OK ✓] [気になる] [NG]     │
│                                              │
│  ※ 気になる/NG にした項目にメモを追加できます │
│                                              │
└──────────────────────────────────────────────┘
```

> - デフォルトは「全部 OK!」ワンタップ
> - 14 項目を 6 カテゴリにグルーピングして認知負荷を下げる
> - 問題がある項目だけ掘り下げて入力

### 4.6 統計画面 (`/stats`)

表示する情報:

| 指標                 | 計算方法                                            |
| -------------------- | --------------------------------------------------- |
| **直近燃費**         | 直近の満タン→満タン間の km/L                        |
| **平均燃費**         | 全満タン給油の燃費の加重平均                        |
| **最高・最低燃費**   | 過去全記録から                                      |
| **燃費推移**         | 給油ごとの km/L を折れ線グラフ                      |
| **推定残燃料**       | タンク容量 − (現在ODO − 最後の満タンODO) ÷ 平均燃費 |
| **推定航続距離**     | 推定残燃料 × 平均燃費                               |
| **月別ガソリン代**   | 棒グラフ                                            |
| **総走行距離**       | 最新 ODO − 初回 ODO (ODO 記録がある場合のみ)        |
| **月別走行距離**     | 棒グラフ                                            |
| **累計ガソリン代**   | 全給油の合計金額                                    |
| **1km あたりコスト** | 累計ガソリン代 ÷ 総走行距離                         |
| **次回給油予測**     | 平均燃費 × タンク容量 で航続距離推定                |

> データが足りない項目は「データが増えると表示されます」と案内。  
> 1回しか記録がなくても直近燃費以外の情報 (給油量とか) は表示する。  
> 給油量不明の満タン記録もタイムラインに「⛽ 満タン」として表示。

---

## 5. 燃費計算ロジック

### 5.1 満タン法

```
燃費 (km/L) = (今回のODO − 前回満タン時のODO) ÷ 今回の給油量
```

### 5.2 データ欠損への対応

| ケース                                 | 対応                                                                                        |
| -------------------------------------- | ------------------------------------------------------------------------------------------- |
| ODO 未入力の給油記録                   | 燃費計算をスキップ。金額・給油量の集計には含める                                            |
| **給油量不明の満タン記録**             | 燃費計算の**基準点**として使用。この時点でタンク = `fuelTankCapacity`。次回の計算起点になる |
| 途中で記録を忘れていた期間がある       | ODO が記録されている給油同士で計算。間の期間は「不明」扱い                                  |
| 満タンでない給油                       | 次の満タン給油時に合算して計算                                                              |
| 最初の給油記録                         | 基準点。燃費算出不可 (正常)                                                                 |
| 前回 ODO > 今回 ODO (入力ミス)         | バリデーション警告は出すが、保存は許可。燃費計算からは除外                                  |
| **給油量不明 + ODO あり + 次回量あり** | 基準点 → 次回で正常に燃費計算可能                                                           |
| **給油量不明 + ODO なし**              | 記録としてのみ保持。計算には使用不可                                                        |

### 5.3 例

| #   | ODO   | 給油量   | 満タン | 燃費計算                                                           |
| --- | ----- | -------- | ------ | ------------------------------------------------------------------ |
| 1   | 1,000 | 12.0L    | ○      | (基準点)                                                           |
| 2   | 1,300 | **不明** | ○      | 量不明 → 燃費計算不可。ただし ODO があるので**次回の基準点**になる |
| 3   | 1,500 | 10.0L    | ○      | (1500−1300) ÷ 10.0 = **20.0 km/L** ← #2 が基準点として機能!        |
| 4   | —     | 5.0L     | ○      | ODO なし → スキップ                                                |
| 5   | 1,800 | 10.0L    | ○      | (1800−1500) ÷ 10.0 = **30.0 km/L**                                 |

> 注: 量不明の満タン記録は「この時点でタンクがリセットされた」マーカー。  
> 次回の給油量がわかれば、その区間の燃費は正常に計算できる。  
> ダッシュボードに「給油量やODOを入れるともっと正確な燃費がわかります」と優しいナッジを表示。

### 5.4 推定残燃料

車両の `fuelTankCapacity` と給油記録を組み合わせて、現在の推定残燃料を計算する。

```
推定残燃料 (L) = タンク容量 − (現在のODO − 最後の満タン時のODO) ÷ 平均燃費
推定航続距離 (km) = 推定残燃料 × 平均燃費
```

**計算条件:**

- 直近の満タン記録 (量不明でもOK) の ODO が必要
- 現在の ODO (最新の ODO 記録 or 給油記録の ODO) が必要
- 平均燃費のデータが必要 (最低1回の燃費計算実績)
- `fuelTankCapacity` が車両プロフィールに登録されていること

**データ不足時:**

- 条件が揃わない場合は「データが増えると表示されます」と案内
- 給油量がわかる満タン記録があれば、その時点の残量 = タンク容量 として確実
- 給油量不明でも満タンなら同様にタンク容量でリセット

**例:**

| 状態                       | 計算                     |
| -------------------------- | ------------------------ |
| タンク容量 14L             |                          |
| 最後の満タン ODO: 5,000 km | → この時点で 14L         |
| 現在の ODO: 5,200 km       | → 200km 走行             |
| 平均燃費: 28.0 km/L        | → 消費量 200 ÷ 28 ≈ 7.1L |
| **推定残燃料**             | **14 − 7.1 = 6.9L**      |
| **推定航続距離**           | **6.9 × 28 = 193 km**    |

---

## 6. メンテナンス推奨スケジュール

アプリ内でアラートを出すための推奨間隔。車両プロフィールでカスタマイズ可能にする。

### 6.1 日常点検カテゴリ (乗る前に毎回)

画面では 6 カテゴリに集約して表示する:

| カテゴリ         | 含まれる項目                                                 |
| ---------------- | ------------------------------------------------------------ |
| **ブレーキ**     | 前後レバー/ペダルの遊び・効き                                |
| **タイヤ**       | 溝・傷・異物の目視                                           |
| **灯火類**       | ヘッドライト・テール・ブレーキランプ・ウインカー             |
| **チェーン**     | たるみ・汚れの目視                                           |
| **エンジン周り** | オイル量・冷却水・燃料残量                                   |
| **操作系**       | クラッチ遊び・スロットル戻り・ホーン・ミラー・サイドスタンド |

### 6.2 週間整備 (週1回 or 500km ごと)

| 項目           | やること                   |
| -------------- | -------------------------- |
| タイヤ空気圧   | ゲージで測定・調整         |
| チェーン注油   | 清掃 & ルブ塗布            |
| チェーンたるみ | 規定値の確認・調整         |
| ブレーキパッド | 残量の目視確認             |
| 液漏れチェック | 駐車場所にオイル跡がないか |

### 6.3 月間点検 (月1回 or 1,000km ごと)

| 項目             | チェック内容         |
| ---------------- | -------------------- |
| エンジンオイル   | 量・色の確認         |
| 冷却水           | リザーブタンクの量   |
| ブレーキフルード | 液量・色             |
| チェーン摩耗     | 伸び量の確認         |
| ボルト類         | 増し締め             |
| 電装系           | 全灯火・メーター動作 |

### 6.4 ショップ整備 (推奨交換サイクル目安)

| 項目                   | 距離目安          | 期間目安           |
| ---------------------- | ----------------- | ------------------ |
| エンジンオイル交換     | 3,000〜5,000 km   | 6ヶ月              |
| オイルフィルター交換   | 6,000〜10,000 km  | オイル交換2回に1回 |
| エアフィルター交換     | 10,000〜15,000 km | 1年                |
| スパークプラグ交換     | 10,000〜20,000 km | −                  |
| ブレーキフルード交換   | −                 | 2年                |
| クーラント交換         | −                 | 2年                |
| ブレーキパッド交換     | 摩耗限度で        | −                  |
| チェーン＆スプロケット | 15,000〜30,000 km | −                  |
| タイヤ交換             | 10,000〜20,000 km | 溝次第             |
| バッテリー交換         | −                 | 2〜3年             |
| フォークオイル交換     | 20,000〜30,000 km | 2年                |

---

## 7. メンテナンスアラート

### 7.1 データソース

アラートは以下を組み合わせて判定する:

- **給油記録の ODO** — 最新の走行距離
- **ショップ整備の `workDone`** — 最後に各作業をした日時と ODO
- **クイック整備の `action`** — 最後にチェーン注油した日時 等
- **推奨交換サイクル** (6.4 の表) — デフォルト値 or ユーザーカスタマイズ

### 7.2 アラートレベル

| レベル      | 表示              | 条件                       |
| ----------- | ----------------- | -------------------------- |
| 🔴 超過     | 赤バッジ          | 推奨距離 or 推奨期間を超過 |
| 🟡 そろそろ | 黄バッジ          | 推奨の 80% に到達          |
| 🟢 OK       | 緑 (普段は非表示) | まだ余裕あり               |

### 7.3 データ不足時の挙動

- ODO 記録がない → 距離ベースのアラートは出さない。期間ベースのみ
- 整備記録がない → 「まだ〇〇の記録がありません。最近やりましたか?」と聞く
- 完全にデータなし → アラートなし (空欄で怖がらせない)

---

## 8. ディレクトリ構成

```
nostr-moto-log/
├── package.json
├── pnpm-lock.yaml
├── svelte.config.js
├── vite.config.ts
├── tsconfig.json
├── tailwind.config.ts
├── 設計書.md
├── static/
│   ├── favicon.ico
│   └── manifest.json
└── src/
    ├── app.html
    ├── app.css                  # Tailwind エントリ
    │
    ├── lib/
    │   ├── nostr/
    │   │   ├── client.ts        # rx-nostr の RxNostr インスタンス管理
    │   │   ├── publish.ts       # イベント publish ヘルパー
    │   │   ├── subscribe.ts     # 購読フィルタ管理
    │   │   └── login.ts         # @konemono/nostr-login 連携
    │   │
    │   ├── stores/
    │   │   ├── auth.svelte.ts   # 認証状態 (Svelte 5 runes)
    │   │   ├── vehicle.svelte.ts
    │   │   ├── records.svelte.ts # 全記録データ
    │   │   └── relays.svelte.ts  # リレー設定
    │   │
    │   ├── models/
    │   │   ├── vehicle.ts       # 型定義 + バリデーション
    │   │   ├── refuel.ts
    │   │   ├── quick-action.ts
    │   │   ├── inspection.ts
    │   │   └── shop.ts
    │   │
    │   ├── services/
    │   │   ├── fuel-calc.ts     # 燃費計算ロジック
    │   │   ├── alerts.ts        # メンテアラート判定
    │   │   └── smart-defaults.ts # 前回値の記憶・自動入力
    │   │
    │   └── components/
    │       ├── layout/
    │       │   ├── Header.svelte
    │       │   └── BottomNav.svelte
    │       ├── dashboard/
    │       │   ├── FuelSummary.svelte
    │       │   ├── FuelChart.svelte
    │       │   ├── AlertList.svelte
    │       │   └── RecentRecords.svelte
    │       ├── forms/
    │       │   ├── RefuelForm.svelte
    │       │   ├── QuickActions.svelte
    │       │   ├── InspectionForm.svelte
    │       │   ├── ShopForm.svelte
    │       │   └── OdometerInput.svelte
    │       ├── history/
    │       │   └── Timeline.svelte
    │       └── stats/
    │           ├── FuelChart.svelte
    │           ├── CostChart.svelte
    │           └── Overview.svelte
    │
    └── routes/
        ├── +layout.svelte       # 共通レイアウト + BottomNav
        ├── +page.svelte         # ログイン画面
        ├── home/
        │   └── +page.svelte     # ダッシュボード
        ├── log/
        │   ├── +page.svelte     # クイック記録ハブ
        │   ├── refuel/
        │   │   └── +page.svelte
        │   ├── quick/
        │   │   └── +page.svelte
        │   ├── inspection/
        │   │   └── +page.svelte
        │   └── shop/
        │       └── +page.svelte
        ├── history/
        │   └── +page.svelte
        ├── stats/
        │   └── +page.svelte
        ├── vehicle/
        │   └── +page.svelte
        └── settings/
            └── +page.svelte
```

---

## 9. rx-nostr によるリレー通信

### 9.1 接続管理

```typescript
import { createRxNostr, createRxForwardReq } from "rx-nostr";

const rxNostr = createRxNostr();

// デフォルトリレーに接続
rxNostr.setDefaultRelays([
  "wss://relay.damus.io",
  "wss://nos.lol",
  "wss://relay.nostr.wirednet.jp",
]);
```

### 9.2 データ取得 (Subscribe)

```typescript
import { createRxForwardReq } from "rx-nostr";

const req = createRxForwardReq();

rxNostr.use(req).subscribe((packet) => {
  const event = packet.event;
  // content をパースして store に格納
});

// ログイン後に購読開始
req.emit({
  kinds: [30078],
  authors: [pubkey],
  "#L": ["nostr-moto-log"],
});
```

### 9.3 データ保存 (Publish)

```typescript
// @konemono/nostr-login の signer を使って署名
const event = await signer.signEvent(unsignedEvent);
rxNostr.send(event);
```

### 9.4 データ削除

kind 5 (NIP-09 Event Deletion) を発行して削除。

---

## 10. @konemono/nostr-login 連携

```svelte
<script>
  import { init as initNostrLogin } from '@konemono/nostr-login';
  import { onMount } from 'svelte';

  onMount(() => {
    initNostrLogin({
      // 設定オプション
    });
  });
</script>
```

ログインフロー:

1. ユーザーがログインボタンをタップ
2. `@konemono/nostr-login` のモーダルが表示
3. NIP-07 (ブラウザ拡張) or NIP-46 (Nostr Connect / nsecBunker) を選択
4. 認証成功 → `window.nostr` に signer がセットされる
5. pubkey を取得 → rx-nostr で購読開始

---

## 11. デフォルトリレー

```
wss://relay.damus.io
wss://nos.lol
wss://relay.nostr.wirednet.jp
```

設定画面でリレーの追加・削除が可能。

---

## 12. UX の工夫

### 12.1 スマートデフォルト

| 項目             | デフォルト値                     |
| ---------------- | -------------------------------- |
| 日付             | 今日                             |
| 満タン           | ON                               |
| 燃料種別         | 車両プロフィールの `fuelType`    |
| ガソリンスタンド | 前回使ったスタンド名をサジェスト |
| 単価             | 前回の単価をプレースホルダー表示 |

### 12.2 優しいナッジ (強制しない)

- 「ODO を入力するともっと正確な燃費がわかります 📊」
- 「前回の空気圧チェックから2週間経ちました 💨」
- 「最近チェーン注油してますか? 🔗」

→ 通知ではなく、ホーム画面にさりげなく表示。ウザくない程度に。

### 12.3 記録した瞬間の体験

1. タップ → 即座に保存 (楽観的 UI)
2. 「記録しました!」トースト表示 (1.5秒で自動消滅)
3. トーストに「詳細を追加」リンク → 追加情報の入力画面へ
4. ホーム画面に戻ると最新記録が反映されている

### 12.4 モバイルファースト

- ガソリンスタンドでスマホから使うことを想定
- 大きなタップターゲット、片手操作対応
- number input は入力時にテンキーが出るように `inputmode="decimal"`
- 横スクロールなし

---

## 13. セキュリティ考慮

### 13.1 秘密鍵の管理

- @konemono/nostr-login に完全委譲。アプリは秘密鍵を直接扱わない
- localStorage / sessionStorage に鍵情報を保存しない

### 13.2 ⚠️ 公開データに関する重要な注意

**kind 30078 のデータはすべて公開情報です。Nostr リレーに保存されたデータは誰でも閲覧可能です。**

以下の情報は**入力しないことを強く推奨**します:

| 入力してはいけない情報              | リスク                                     |
| ----------------------------------- | ------------------------------------------ |
| 🚨 **ナンバープレート番号**         | 車両の特定 → 所有者の特定につながる        |
| 🚨 **VIN (車台番号)**               | 車両のフル特定が可能                       |
| 🚨 **自宅近くのガソリンスタンド名** | 生活圏の特定につながる                     |
| 🚨 **バイク屋さんの具体的な店舗名** | 生活圏の特定につながる                     |
| 🚨 **正確な購入日/納車日**          | 他の情報との照合で個人特定の手がかりに     |
| ⚠️ **メモ欄に個人情報**             | 電話番号・住所・名前などをうっかり書かない |

**アプリ内での対策:**

1. **初回利用時に警告ダイアログを表示** — 「このアプリのデータはNostrに公開情報として保存されます。個人を特定できる情報(ナンバープレート、自宅近くの店舗名等)は入力しないでください。」
2. **車両登録画面に常時注意書き** — フォーム上部にバナーで表示
3. **ガソリンスタンド・ショップ名の入力欄に注意テキスト** — プレースホルダーに「※公開されます。特定されない名前で」
4. **設定画面に注意事項ページへのリンク**

### 13.3 将来的な暗号化対応

- NIP-44 による content の暗号化を検討
- 暗号化後は自分だけが読めるプライベートデータになる
- 実装されるまでは上記の注意を徹底する

---

## 14. 開発フェーズ

### Phase 1: MVP (とにかく使えるように)

- [ ] プロジェクトセットアップ (SvelteKit + Tailwind + rx-nostr)
- [ ] @konemono/nostr-login でログイン
- [ ] 車両登録 (名前だけで OK)
- [ ] 給油記録の登録 (給油量だけで OK)
- [ ] 給油履歴の一覧表示
- [ ] 燃費計算 (ODO がある記録同士で)

### Phase 2: クイック記録 + 点検

- [ ] クイック整備記録 (ワンタップ系)
- [ ] 日常点検 (全部 OK! ワンタップ)
- [ ] 週間 / 月間点検フォーム
- [ ] ショップ整備記録
- [ ] 走行距離 (ODO) 記録

### Phase 3: ダッシュボード + 分析

- [ ] ホーム画面 (燃費サマリー + 直近記録)
- [ ] 燃費推移グラフ
- [ ] メンテナンスアラート
- [ ] 統計画面 (月別コスト・走行距離)
- [ ] スマートデフォルト (前回値の記憶)

### Phase 4: 仕上げ + 拡張

- [ ] PWA 対応 (ホーム画面追加・オフライン)
- [ ] データエクスポート (JSON)
- [ ] 複数車両対応
- [ ] NIP-44 暗号化対応
