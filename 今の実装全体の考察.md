# 今の実装全体の考察

全ソースコードを通読した上での、アーキテクチャ・品質・一貫性の観点での分析。

---

## 全体評価

MVP としてはかなり良いレベル。SvelteKit + Svelte 5 Runes の使い方は正しく、Nostr 連携もシンプルにまとまっている。ただし「個別に機能を足していった」跡が残っていて、全体で見ると重複・不整合・抜けがいくつかある。

---

## 🟢 よくできている点

| 観点             | 内容                                                                                                                           |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------ |
| 型定義           | `types.ts` に全レコード型が集約されており、見通しがいい                                                                        |
| ストア設計       | `app.svelte.ts` に auth / vehicleStore / records がまとまっていて、Svelte 5 Runes (`$state`, `$derived`) を正しく使っている    |
| Nostr レイヤー   | client / publish / subscribe の 3 ファイルに分離。kind 30078 (Parameterized Replaceable) の仕組みを活かして d-tag でデータ管理 |
| UX               | ワンタップ給油、自動プリフィル (前回単価・スタンド名)、空気圧リマインダー、プライバシー警告など細かい配慮がある                |
| セキュリティ意識 | ログイン前のプライバシー警告、各入力フォームでの「公開される」注意、セキュリティリマインダー                                   |
| 燃費計算         | `fuel-calc.ts` の満タン法ロジックが堅実。fuelAmount 不明の区間スキップも考慮されている                                         |

---

## 🔴 バグ (動作に影響するもの)

### 1. ✅ Done: 履歴のショップカテゴリ表示が間違っている

**場所**: `history/+page.svelte` (ショップカード内)

```js
// 現在のコード
{ periodic: "定期", repair: "修理", inspection: "車検", other: "その他" }[r.category]
```

**問題**: `ShopCategory` の値は `"regular" | "repair" | "shaken" | "custom"` なのに、マッピングキーが `periodic / inspection / other` になっている。`regular → 定期`、`shaken → 車検`、`custom → その他` に修正が必要。

### 2. ✅ Done: deleteEvent に空の eventId を渡している

**場所**: `edit/+page.svelte` → `deleteEvent("", recordId)`

```ts
// publish.ts
tags: [
  ["e", eventId], // ← 空文字列 "" が入る
  ["a", `30078:${await nostr.getPublicKey()}:${dTag}`],
];
```

**問題**: Nostr のイベント ID (sha256 hash) をどこにも保存していないため、`e` tag に空文字が入る。`a` tag があるので NIP-09 削除としては動く可能性はあるが、仕様的にはグレー。リレーによっては無視される。

### 3. ✅ Done: clearLocalData の直接配列変更

**場所**: `settings/+page.svelte`

```ts
vehicleStore.vehicles.length = 0; // ← $state の配列を直接変更
```

**問題**: Svelte 5 では `$state` の配列を `.length = 0` で変更しても反応性が保証されない場合がある。`vehicleStore.setVehicles([])` のようなメソッド経由が正しい。

---

## 🟡 設計上の問題 (機能不整合・重複)

### 4. ✅ Done: 定数・ラベルの重複定義 (5 箇所以上)

`quickActionLabels` が **5 ファイル**にコピーされている:

- `history/+page.svelte`
- `stats/+page.svelte`
- `edit/+page.svelte`
- `home/+page.svelte`
- (log/+page.svelte はアイコンバリエーション)

`workOptions` (ショップ作業リスト) も shop と edit に重複。

→ `$lib/constants.ts` に集約すべき。修正時に漏れが出る (実際にカテゴリ表示の不整合が発生)。

### 5. ✅ Done: fuelType ラベル変換ロジックの重複

```ts
v.fuelType === "premium" ? "ハイオク" : v.fuelType === "diesel" ? "軽油" : ...
```

これが settings、refuel の 2 箇所に三項演算子の巨大チェーンとして存在。ユーティリティ関数にすべき。

### 6. トースト通知の重複実装 ✅ Done

`toastStore` (stores/toast.svelte.ts) + `Toast.svelte` コンポーネントを作成し、`+layout.svelte` にグローバル配置。4 ページの個別実装を削除。

→ 共通コンポーネント (`Toast.svelte`) またはストア (`toastStore`) に集約すべき。→ 完了

### 7. ODO 記録の非対称性 ✅ Done

全記録種別 (Refuel, Inspection, Shop) で ODO 入力時に OdometerRecord も作成するよう統一。Quick Action と同じパターンに揃えた。

| 記録種別     | ODO 入力時に OdometerRecord も作成?  |
| ------------ | ------------------------------------ |
| Quick Action | ✅ 別途 `odometer:` イベントも作成   |
| Refuel       | ❌ refuel レコード内の odometer のみ |
| Inspection   | ❌ inspection レコード内のみ         |
| Shop         | ❌ shop レコード内のみ               |

→ `getTotalDistance()` は refuel の odometer しか見ていないため、他の ODO データが反映されない。ODO の最新値も refuel 以外のソースを拾えていない箇所がある (home の `estimateRemainingFuel` など一部は対応済み)。

### 8. 編集ページの欠落フィールド ✅ Done

Quick 編集に `odometer` フィールド追加、Inspection 編集に `odometer` + `issues` 個別編集 UI を追加。

| 記録種別   | 新規フォームにあるが編集フォームにないフィールド   |
| ---------- | -------------------------------------------------- |
| Quick      | `odometer` (新規では入力可能、編集では編集不可)    |
| Inspection | `odometer`、`issues` の個別編集 (allOk トグルのみ) |

---

## 🟠 アーキテクチャ上の懸念

### 9. subscribe.ts の信頼性 ✅ Done

15秒タイムアウトを追加。タイムアウト時は取得済みデータで resolve。subscription の cleanup も追加。

```ts
const subscription = rxNostr.use(req).pipe(uniq()).subscribe({
  next: ...,
  complete: () => { resolve(data); }
});
req.emit({ ... });
req.over();
```

- `req.over()` で complete が呼ばれる前提だが、リレーからの応答が遅い場合や接続失敗時の **タイムアウト機構がない**。永久に resolve されない可能性がある。
- `subscription` が使われていない (cleanup されていない)。

### 10. publishEvent の Fire-and-Forget ✅ Done

`rxNostr.send()` の戻り値 Observable を購読し、少なくとも1つのリレーから OK を待つように変更 (10秒タイムアウト)。deleteEvent も同様に対応。

```ts
rxNostr.send(signed); // ← await していない、成功確認もしない
```

- リレーへの到達確認 (OK メッセージ) を待っていない。保存に失敗しても UI は成功と表示する。
- 少なくとも 1 つのリレーに OK をもらうまで待つ方が安全。

### 11. ストアにリアルタイム購読がない — Skip (将来的に)

単一ユーザー前提の MVP では優先度低。マルチデバイス同期が必要になった時点で Forward req を追加する。

- `loadAllData` は backward req (過去データ取得) のみ。
- 別デバイスからの変更がリアルタイムで反映されない。
- Forward req (リアルタイム購読) のインポートはあるが使っていない。

### 12. 全レコードをメモリ上に保持 — Skip (将来的に)

100件程度なら問題なし。1000件超の長期利用時に仮想スクロール/ページネーションを検討する。

- `records` ストアに全レコードを `$state` で保持。
- ページネーション/仮想スクロールなし。
- 100件程度なら問題ないが、長期利用で 1000+件になるとパフォーマンス劣化の可能性。

---

## 🔵 UX/UI の整合性

### 13. 保存後の遷移先が不統一 ✅ Done

全新規記録 (Quick, Inspection, Shop) をトースト表示 + 1.2秒後に `/home` へ遷移するよう統一。Refuel は既に同パターン。Edit は `/history` 遷移のまま (意図的)。

| 記録種別      | 保存後の遷移先          |
| ------------- | ----------------------- |
| Refuel        | `/home` (1.2秒遅延)     |
| Quick         | そのまま (トースト表示) |
| Inspection    | そのまま (トースト表示) |
| Shop          | `/home` (即時)          |
| Edit (全種別) | `/history` (即時)       |

→ 新規記録は「記録ページに留まる」か「ホームに戻る」かが統一されていない。

### 14. Relay 設定 UI の未完成 ✅ Done

未使用の `relayInput`/`showRelayForm` state を削除。リレー一覧を `getDefaultRelays()` から取得に変更。`rxNostr.createConnectionStateObservable()` を購読してリアルタイムに接続状態 (接続中/待機中/エラー等) を表示するよう実装。

`settings/+page.svelte` に `relayInput` と `showRelayForm` の state があるが、UI に反映されていない。リレーは全て「接続中」と表示されるが、実際の接続状態は確認していない。

### 15. エクスポートがアクティブ車両のみ ✅ Done

`exportData()` を全車両の記録をエクスポートするように変更。

`exportData()` は `activeVehicleId` のタイムラインしかエクスポートしない。複数車両持ちのユーザーは全車両分エクスポートしたいはず。

---

## 📊 ファイルサイズと複雑度

| ファイル               | 行数 | 懸念                                                              |
| ---------------------- | ---- | ----------------------------------------------------------------- |
| `edit/+page.svelte`    | 726  | 全記録種別の編集フォームが 1 ファイルに。コンポーネント分割したい |
| `home/+page.svelte`    | 511  | ダッシュボード全部入り。ウィジェットに分割できる                  |
| `stats/+page.svelte`   | 552  | 3タブの統計が 1 ファイル                                          |
| `history/+page.svelte` | 460  | フィルタ+グルーピング+5種カード。まだ許容範囲                     |
| `app.svelte.ts`        | 244  | ストア全部入り。記録数が増えたら分割検討                          |

---

## 🏗️ 改善優先度の提案

### 即座に直すべき (バグ)

1. ショップカテゴリのマッピングキー修正 (`regular`/`shaken`/`custom`)
2. `deleteEvent` の eventId 問題の対応
3. `clearLocalData` の配列クリア方法修正

### 近いうちに直すべき (品質)

4. 定数・ラベルの集約 (`$lib/constants.ts`)
5. トースト通知の共通化
6. 編集ページに不足フィールド追加 (quick の ODO 等)
7. fuelType ラベル変換をユーティリティ化

### 余裕があれば (堅牢性)

8. `loadAllData` にタイムアウト追加
9. `publishEvent` で最低 1 relay の OK を待つ
10. ODO 記録の統一 (全記録種別で OdometerRecord も作成する or getTotalDistance を全ソース対応)
11. エクスポートを全車両対応に
12. 大きいページのコンポーネント分割

### 将来的に (スケーラビリティ)

13. Forward req でリアルタイム同期
14. 仮想スクロール / ページネーション
15. Service Worker によるオフラインキャッシュ

---

## まとめ

全体的には **MVP として十分実用的なレベル** に達している。最大の問題は「機能追加の積み重ねで生じた重複と不整合」で、特に **定数の 5 箇所重複**と**ショップカテゴリの表示バグ**は実用上の影響がある。コードの DRY 原則を適用して定数・トースト・ユーティリティを集約すれば、保守性が大幅に向上する。

Nostr レイヤーの信頼性 (タイムアウト・publish 確認) は、実際にリレー障害が起きた時に初めて問題が顕在化するが、早めの対策が望ましい。
