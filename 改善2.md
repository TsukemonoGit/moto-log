# 改善ポイント一覧

---

## 🔴 バグ・不具合

### ログイン処理のタイミング問題

- 初手ページを開いたときにログイン処理が走らないことがある
- **原因の仮説**: `+layout.svelte` で `nostr-login` の `init()` 完了時に `initializing = false` になるが、実際の自動ログイン（`nlAuth` イベント発火）は非同期でそれより後に来る。そのため `$effect` のリダイレクトが「まだロード中」と判定されうる
- **別問題**: `+page.svelte`（トップ）の手動ログイン `doLogin()` と `+layout.svelte` の `handleAuthLogin()` でほぼ同じ処理が重複しており、手動ログイン側では `pagination.setCursor()` の呼び出しが漏れている

---

## 🟡 機能追加・改善

### メンテ警告の閾値をユーザーが設定できるようにする

- ホーム画面の `maintenanceItems` でチェーン注油=7日/14日、空気圧=14日/30日などがハードコード
- 乗り方・バイクの種類で適切な頻度は異なるため、設定画面で各アクションの警告・危険日数を変更できるようにしたい

### 車両削除機能がない

- `/vehicle` ページには編集フォームしかなく削除ボタンがない
- 廃車・乗り換えで不要になった車両を削除できない

### カスタム整備アクションが未実装

- `QuickActionType` に `"custom"` が型定義されているが、記録ページのボタン一覧に含まれていない（入力できない）

### ローカル永続化がない（毎回Nostrから再取得）

- ページリロードのたびに全データをNostrリレーから取得し直すため、初期表示が遅い
- `localStorage` や `IndexedDB` にキャッシュしてオフラインでも閲覧できると良い

### JSONインポート機能がない

- 設定画面にJSONエクスポートはあるがインポートがない
- 機種変更・アカウント移行時にローカルバックアップからリストアできない

### リレーをユーザーが変更できない

- `client.ts` でリレー3件がハードコード
- 設定画面でリレー一覧の閲覧はできるが、追加・変更・削除ができない

### オドメーターの逆行チェックがない

- 前回より小さいODO値を入力してもバリデーションエラーが出ない
- 誤入力（桁ミスなど）の気づきが遅れる

---

## 🟢 UX・コード品質

### 統計ページにビジュアルグラフがない

- `stats/+page.svelte` で月別コスト・ガソリン単価推移などのデータは計算しているが、グラフライブラリ（Chart.js等）を使ったビジュアル表示になっていない（テキスト・数値のみ）

### ヘッダーの車両切り替えメニューが `onmouseleave` で閉じる

- PCではホバーアウトで閉じるが、スマホ（タッチ操作）ではメニューが閉じにくい。タップアウトで閉じる実装に変更すべき

### コードの重複・分割

- `subscribe.ts` と `publish.ts` で `APP_LABEL = "nostr-moto-log"` が重複定義 → `constants.ts` に移すべき
- `home/+page.svelte` が508行と長い（燃費・残燃料・メンテ表示・リマインダーなど）→ コンポーネント分割推奨
- `history/+page.svelte` 内で `(item.record as any)` が多用されており型安全性が低い

---

## 📝 修正ログ

### P1 (最高優先): ログイン処理のバグ修正 ✅

**問題:** 初回アクセス時に自動ログインが走らないことがある。手動ログインで `pagination.setCursor()` が漏れていた。

**修正内容:**

- `+layout.svelte`: `nostr-login` の `init()` 完了後 500ms で `window.nostr` が存在し未ログインなら `handleAuthLogin()` をフォールバック実行
- `+page.svelte`: `doLogin()` に `pagination.setCursor(data.cursor, data.hasMore)` を追加。import に `pagination` を追加

**修正ファイル:**

- `src/routes/+layout.svelte`
- `src/routes/+page.svelte`

---

### P2: APP_LABEL 重複定義の解消 ✅

**問題:** `subscribe.ts` と `publish.ts` で `APP_LABEL = "nostr-moto-log"` が重複定義されていた。

**修正内容:**

- `APP_LABEL` を `src/lib/constants.ts` に一元化
- `publish.ts` と `subscribe.ts` から `constants.ts` の `APP_LABEL` を import

**修正ファイル:**

- `src/lib/constants.ts`
- `src/lib/nostr/publish.ts`
- `src/lib/nostr/subscribe.ts`

---

### P3: 車両切り替えメニューのスマホ対応 ✅

**問題:** `onmouseleave` でメニューを閉じていたため、スマホではメニューが閉じにくかった。

**修正内容:**

- 透明な backdrop (`fixed inset-0`) を追加し、タップアウトで閉じるように変更
- `onmouseleave` を削除

**修正ファイル:**

- `src/routes/+layout.svelte`

---

### P4: オドメーター逆行チェックの追加 ✅

**問題:** 前回の記録より小さいODO値を入力してもバリデーション警告が出なかった。

**修正内容:**

- `app.svelte.ts` に `getLatestOdometer(vehicleId)` メソッドを追加（全記録種別から最大ODOを取得）
- 4ページ（クイック整備・給油・ショップ・点検）のODO入力欄に逆行時の警告メッセージを追加

**修正ファイル:**

- `src/lib/stores/app.svelte.ts`
- `src/routes/log/+page.svelte`
- `src/routes/log/refuel/+page.svelte`
- `src/routes/log/shop/+page.svelte`
- `src/routes/log/inspection/+page.svelte`

---

### P5: 車両削除機能の実装 ✅

**問題:** 編集フォームに削除ボタンがなく、不要な車両を削除できなかった。

**修正内容:**

- `vehicleStore` に `removeVehicle(id)` メソッドを追加（アクティブ車両が削除された場合は別の車両に自動切り替え)
- `vehicle/+page.svelte` に削除ボタンを追加（確認ダイアログ付き、Nostrイベントも kind:5 で削除）

**修正ファイル:**

- `src/lib/stores/app.svelte.ts`
- `src/routes/vehicle/+page.svelte`

---

### P6: カスタム整備アクション実装 ✅

**問題:** `QuickActionType` に `"custom"` が型定義されていたが、記録UIから入力できなかった。

**修正内容:**

- 記録ページのワンタップ整備グリッドに「📝 その他」ボタンを追加
- タップすると整備内容名を入力するテキストフィールドが表示される
- `content.customName` としてカスタム名を記録に保存

**修正ファイル:**

- `src/routes/log/+page.svelte`

---

## 📋 未着手項目 (今後の改善候補)

| 優先度 | 項目                         | 概要                                                   |
| ------ | ---------------------------- | ------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 中     | メンテ警告閾値のカスタマイズ | 設定画面で各アクションの警告・危険日数を変更可能にする | やる                                                                                                                                                                               |
| 中     | ローカル永続化 (IndexedDB)   | リロード時にNostrから全取得し直さない仕組み            | あとで                                                                                                                                                                             |
| 中     | 統計ページのグラフ表示       | Chart.js 等で燃費推移・月別コストをビジュアル化        | やる                                                                                                                                                                               |
| 低     | JSONインポート機能           | エクスポートしたデータからリストア                     | どっちでもいい                                                                                                                                                                     |
| 低     | リレーの追加・変更           | 設定画面でリレー一覧を編集可能にする                   | このアプリで使うこと前提だからこのアプリ間で共通リレーのほうが取りこぼし解かなくていいかも（ハードコードでいい）まあでも変更したい人は変更できてもいいかも。だからまあ後々でいいか |
| 低     | コンポーネント分割           | home/+page.svelte を分割しメンテナビリティ向上         | やる                                                                                                                                                                               |
| 低     | history の型安全性           | `(item.record as any)` の排除                          | やる                                                                                                                                                                               |
